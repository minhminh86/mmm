<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô Phỏng Bảng Điều Khiển Thi Lái Xe B2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .control-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .control-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .status-display-item {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-item {
            border-left: 3px solid #3b82f6; /* blue-500 */
        }
        .log-item.error {
            border-left: 3px solid #ef4444; /* red-500 */
        }
        .result-pass {
            color: #22c55e; /* green-500 */
            text-shadow: 0 0 10px #22c55e;
        }
        .result-fail {
            color: #ef4444; /* red-500 */
            text-shadow: 0 0 10px #ef4444;
        }
    </style>
</head>
<body class="text-white antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-400">Trình Mô Phỏng Thi Sa Hình B2</h1>
            <p class="text-gray-400 mt-2">Luyện tập các bài thi và lỗi để đạt điểm tối đa!</p>
        </header>

        <!-- Voice Warning -->
        <div id="voice-warning" class="hidden text-center text-yellow-400 bg-yellow-900/50 p-3 rounded-lg mb-6">
            Không tìm thấy giọng đọc Tiếng Việt trên thiết bị của bạn. Tính năng đọc các mục sẽ không khả dụng.
        </div>

        <!-- Status Display -->
        <div class="grid grid-cols-3 gap-4 mb-8 text-center">
            <div id="score-display" class="status-display-item p-4 rounded-lg">
                <p class="text-sm text-gray-400 uppercase">Điểm số</p>
                <p class="text-3xl font-bold">100</p>
            </div>
            <div id="timer-display" class="status-display-item p-4 rounded-lg">
                <p class="text-sm text-gray-400 uppercase">Thời gian</p>
                <p class="text-3xl font-bold">00:00</p>
            </div>
            <div id="result-display" class="status-display-item p-4 rounded-lg">
                <p class="text-sm text-gray-400 uppercase">Kết quả</p>
                <p id="result-text" class="text-3xl font-bold">---</p>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="flex justify-center mb-8">
            <button id="start-reset-btn" class="w-full md:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl control-button">
                BẮT ĐẦU BÀI THI
            </button>
        </div>

        <!-- Button Panel -->
        <div id="button-panel" class="bg-gray-800 p-4 md:p-6 rounded-lg border border-gray-700">
            <!-- Buttons will be generated by JavaScript -->
        </div>

        <!-- Event Log -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">Nhật Ký Bài Thi</h2>
            <div id="log-container" class="bg-gray-800 p-4 rounded-lg h-64 overflow-y-auto border border-gray-700">
                <p id="log-placeholder" class="text-gray-500">Nhấn "BẮT ĐẦU BÀI THI" để ghi lại các thao tác.</p>
                <ul id="log-list" class="space-y-3">
                    <!-- Log items will be generated here -->
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const INITIAL_SCORE = 100;
            const TIME_LIMIT_MINUTES = 18;
            const PASS_SCORE = 80;
            const TIME_LIMIT_SECONDS = TIME_LIMIT_MINUTES * 60;

            const buttonsConfig = [
                { 
                    group: 'CÁC BÀI THI CHÍNH',
                    items: [
                        { label: 'Xuất phát', points: 0, type: 'test', fullText: 'Bắt đầu bài thi sa hình.' },
                        { label: 'Dừng xe nhường đường cho người đi bộ', points: 0, type: 'test', fullText: 'Bài thi dừng xe nhường đường cho người đi bộ.' },
                        { label: 'Dừng và khởi hành xe ngang dốc', points: 0, type: 'test', fullText: 'Bài thi dừng và khởi hành xe ngang dốc.' },
                        { label: 'Qua vệt bánh xe và đường hẹp vuông góc', points: 0, type: 'test', fullText: 'Bài thi qua vệt bánh xe và đường hẹp vuông góc.' },
                        { label: 'Qua ngã tư có tín hiệu', points: 0, type: 'test', fullText: 'Bài thi qua ngã tư có tín hiệu điều khiển giao thông.' },
                        { label: 'Đường vòng quanh co', points: 0, type: 'test', fullText: 'Bài thi đường vòng quanh co.' },
                        { label: 'Ghép xe dọc', points: 0, type: 'test', fullText: 'Bài thi ghép xe dọc vào nơi đỗ.' },
                        { label: 'Dừng nơi có đường sắt', points: 0, type: 'test', fullText: 'Bài thi dừng xe nơi có đường sắt chạy qua.' },
                        { label: 'Thay đổi số trên đường bằng', points: 0, type: 'test', fullText: 'Bài thi thay đổi số trên đường bằng.' },
                        { label: 'Ghép xe ngang', points: 0, type: 'test', fullText: 'Bài thi ghép xe ngang vào nơi đỗ.' },
                        { label: 'Tình huống khẩn cấp', points: 10, type: 'error', fullText: 'Lỗi không bật tín hiệu khẩn cấp.' },
                        { label: 'Kết thúc', points: 0, type: 'test', fullText: 'Kết thúc bài thi.' },
                    ]
                },
                {
                    group: 'CÁC LỖI TRỪ ĐIỂM THƯỜNG GẶP',
                    items: [
                        { label: 'Lái xe đè vạch', points: 5, type: 'error', fullText: 'Lỗi đè vạch.' },
                        { label: 'Xe bị chết máy', points: 5, type: 'error', fullText: 'Lỗi xe chết máy.' },
                        { label: 'Không bật xi nhan', points: 5, type: 'error', fullText: 'Lỗi không bật xi nhan.' },
                        { label: 'Không tắt xi nhan', points: 5, type: 'error', fullText: 'Lỗi không tắt xi nhan.' },
                        { label: 'Dừng xe quá vạch', points: 5, type: 'error', fullText: 'Lỗi dừng xe quá vạch quy định.' },
                        { label: 'Dừng xe chưa đến vạch', points: 5, type: 'error', fullText: 'Lỗi dừng xe chưa tới vạch.' },
                        { label: 'Vượt đèn đỏ', points: 10, type: 'error', fullText: 'Lỗi vượt đèn đỏ.' },
                        { label: 'Lái xe quá tốc độ', points: 1, type: 'error', fullText: 'Lỗi quá tốc độ.'},
                        { label: 'Đi sai làn đường', points: 5, type: 'error', fullText: 'Lỗi đi sai làn đường.' },
                    ]
                }
            ];

            // --- DOM ELEMENTS ---
            const scoreDisplay = document.getElementById('score-display').querySelector('p:last-child');
            const timerDisplay = document.getElementById('timer-display').querySelector('p:last-child');
            const resultText = document.getElementById('result-text');
            const startResetBtn = document.getElementById('start-reset-btn');
            const buttonPanel = document.getElementById('button-panel');
            const logList = document.getElementById('log-list');
            const logPlaceholder = document.getElementById('log-placeholder');
            const voiceWarning = document.getElementById('voice-warning');

            // --- STATE VARIABLES ---
            let score = INITIAL_SCORE;
            let seconds = 0;
            let timerInterval = null;
            let isTestRunning = false;
            let audioReady = false;
            let speechReady = false;

            // --- AUDIO SETUP (Tone.js) ---
            let successSynth, failSynth;

            function setupAudio() {
                if (audioReady) return;
                successSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                failSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                audioReady = true;
            }

            // --- SPEECH SYNTHESIS SETUP ---
            let speechSynth = window.speechSynthesis;
            let vietnameseVoice = null;

            function loadAndSetVoice() {
                const voices = speechSynth.getVoices();
                vietnameseVoice = voices.find(voice => voice.lang === 'vi-VN' && voice.name.includes('Nữ')) || voices.find(voice => voice.lang === 'vi-VN');
                
                if (!vietnameseVoice) {
                    console.warn("Không tìm thấy giọng đọc Tiếng Việt trên hệ thống.");
                    if (voiceWarning) voiceWarning.classList.remove('hidden');
                } else {
                     if (voiceWarning) voiceWarning.classList.add('hidden');
                }
            }

            function speak(text) {
                if (!speechSynth || !vietnameseVoice || !isTestRunning) {
                    return;
                }
                speechSynth.cancel(); // Stop any previous speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = vietnameseVoice;
                utterance.lang = 'vi-VN';
                utterance.rate = 0.95;
                utterance.pitch = 1.1;
                speechSynth.speak(utterance);
            }
            
            // Load voices initially and on change
            loadAndSetVoice();
            if (speechSynth.onvoiceschanged !== undefined) {
                speechSynth.onvoiceschanged = loadAndSetVoice;
            }

            // --- FUNCTIONS ---
            const createButtons = () => {
                buttonPanel.innerHTML = '';
                buttonsConfig.forEach(group => {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mb-6';
                    
                    const groupTitle = document.createElement('h3');
                    groupTitle.className = 'text-lg font-semibold text-gray-400 mb-3 border-b border-gray-700 pb-2';
                    groupTitle.textContent = group.group;
                    groupContainer.appendChild(groupTitle);

                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3';
                    
                    group.items.forEach(item => {
                        const button = document.createElement('button');
                        const isError = item.type === 'error';
                        button.className = `control-button p-3 rounded-md text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed ${
                            isError ? 'bg-red-600 hover:bg-red-700 focus:ring-red-500' : 'bg-gray-600 hover:bg-gray-700 focus:ring-blue-500'
                        }`;
                        button.textContent = item.label;
                        button.dataset.points = item.points;
                        button.dataset.fullText = item.fullText;
                        button.dataset.type = item.type;
                        button.disabled = true;
                        button.addEventListener('click', handleControlButtonClick);
                        grid.appendChild(button);
                    });

                    groupContainer.appendChild(grid);
                    buttonPanel.appendChild(groupContainer);
                });
            };

            const updateTimer = () => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${mins}:${secs}`;

                if (seconds >= TIME_LIMIT_SECONDS) {
                    logEvent('Lỗi: Quá tổng thời gian bài thi.', 15, 'error');
                    endTest('fail');
                }
            };

            const logEvent = (text, points, type) => {
                if(logPlaceholder) logPlaceholder.style.display = 'none';

                const li = document.createElement('li');
                const pointText = points > 0 ? `(-${points} điểm)` : '';
                li.className = `log-item p-2 bg-gray-900 rounded-md text-sm ${type === 'error' ? 'error' : ''}`;
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${text}</span>
                        <span class="font-semibold ${type === 'error' ? 'text-red-400' : 'text-green-400'}">${pointText}</span>
                    </div>
                `;
                logList.prepend(li);

                if (points > 0) {
                    score -= points;
                    if (score < 0) score = 0;
                    scoreDisplay.textContent = score;
                }

                if (score < PASS_SCORE && isTestRunning) {
                    endTest('fail');
                }
            };

            const handleControlButtonClick = (e) => {
                const { points, fullText, type } = e.target.dataset;
                
                speak(fullText);
                logEvent(fullText, parseInt(points), type);

                if (fullText === 'Kết thúc bài thi.') {
                    endTest(score >= PASS_SCORE ? 'pass' : 'fail');
                }
            };

            const endTest = (result) => {
                if (!isTestRunning) return;

                isTestRunning = false;
                clearInterval(timerInterval);
                timerInterval = null;
                startResetBtn.textContent = 'BẮT ĐẦU BÀI THI MỚI';
                startResetBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startResetBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                document.querySelectorAll('#button-panel button').forEach(b => b.disabled = true);

                if (result === 'pass') {
                    resultText.textContent = 'ĐẠT';
                    resultText.className = 'text-3xl font-bold result-pass';
                    const endText = `Chúc mừng! Bạn đã hoàn thành bài thi với ${score} điểm.`;
                    logEvent(endText, 0, 'test');
                    speak(endText);
                    if(audioReady) successSynth.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '8n', Tone.now());
                } else {
                    resultText.textContent = 'TRƯỢT';
                    resultText.className = 'text-3xl font-bold result-fail';
                    const endText = `Rất tiếc! Bạn đã không hoàn thành bài thi. Điểm cuối cùng: ${score}.`;
                    logEvent(endText, 0, 'error');
                    speak(endText);
                    if(audioReady) failSynth.triggerAttackRelease(['C3', 'D#3', 'G#3'], '4n', Tone.now());
                }
            };

            const toggleTestState = async () => {
                if (!audioReady) {
                    await Tone.start();
                    setupAudio();
                }
                if (!speechReady) {
                    loadAndSetVoice();
                    speechReady = true;
                }

                if (isTestRunning) {
                    endTest('fail');
                    setTimeout(resetUI, 100);
                } else {
                    isTestRunning = true;
                    score = INITIAL_SCORE;
                    seconds = 0;
                    logList.innerHTML = '';
                    if(logPlaceholder) logPlaceholder.style.display = 'block';

                    scoreDisplay.textContent = score;
                    timerDisplay.textContent = '00:00';
                    resultText.textContent = 'ĐANG THI';
                    resultText.className = 'text-3xl font-bold text-yellow-400';
                    
                    startResetBtn.textContent = 'KẾT THÚC / LÀM LẠI';
                    startResetBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    startResetBtn.classList.add('bg-red-600', 'hover:bg-red-700');

                    document.querySelectorAll('#button-panel button').forEach(b => b.disabled = false);
                    
                    timerInterval = setInterval(updateTimer, 1000);
                    const startText = 'Bài thi bắt đầu. Chúc bạn may mắn!';
                    logEvent(startText, 0, 'test');
                    speak(startText);
                }
            };

            const resetUI = () => {
                isTestRunning = false;
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = null;
                speechSynth.cancel();
                
                score = INITIAL_SCORE;
                seconds = 0;
                
                scoreDisplay.textContent = INITIAL_SCORE;
                timerDisplay.textContent = '00:00';
                resultText.textContent = '---';
                resultText.className = 'text-3xl font-bold';
                logList.innerHTML = '';
                if(logPlaceholder) logPlaceholder.style.display = 'block';

                startResetBtn.textContent = 'BẮT ĐẦU BÀI THI';
                startResetBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startResetBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                document.querySelectorAll('#button-panel button').forEach(b => b.disabled = true);
            };

            // --- INITIALIZATION ---
            createButtons();
            startResetBtn.addEventListener('click', toggleTestState);
        });
    </script>

</body>
</html>
